<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Match</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            touch-action: manipulation;
            user-select: none;
            overflow: hidden;
        }

        /* Card Styles */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            aspect-ratio: 3/2;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            position: relative;
            z-index: 10;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card.selected {
            border-color: #3b82f6; /* Blue-500 */
            background-color: #eff6ff; /* Blue-50 */
            transform: scale(0.95);
        }

        .card.missed-set-highlight {
            border-color: #f59e0b !important; /* Amber-500 */
            background-color: #fffbeb !important; /* Amber-50 */
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4) !important;
            transform: scale(1.05);
            z-index: 20;
            animation: pulse-gold 1s infinite;
        }

        /* --- Animations --- */

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .shake-anim {
            animation: shake 0.3s ease-in-out;
            border-color: #ef4444 !important; /* Red-500 */
            background-color: #fef2f2 !important;
        }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); border-color: #f59e0b; }
            50% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.7); border-color: #d97706; }
        }

        /* --- Card Removal Animations --- */

        /* Basic (Low Tier) */
        @keyframes fadeOutSimple {
            to { opacity: 0; transform: scale(0.8); }
        }
        .matched-basic {
            animation: fadeOutSimple 0.4s ease-out forwards;
            background-color: #f0fdf4 !important; /* Green-50 */
            border-color: #22c55e !important;
        }

        /* Confetti/Fireworks Tier Card Effect */
        @keyframes popBright {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); background-color: #fff; }
            100% { transform: scale(0); opacity: 0; }
        }
        .matched-high-tier {
            animation: popBright 0.4s ease-in forwards;
            z-index: 50;
        }

        /* SVG Patterns */
        svg { width: 100%; height: 100%; }

        /* Grid Layout */
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 640px) {
            #game-board {
                gap: 1.5rem;
            }
        }

        /* Submenu Styling */
        .mode-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mode-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body id="main-body" class="h-screen w-screen flex flex-col overflow-hidden text-slate-800 bg-slate-100">

    <!-- FX Layer -->
    <div id="effects-layer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <!-- Header / HUD (Hidden Initially) -->
    <header id="game-header" class="flex-none p-4 flex justify-between items-center bg-white shadow-sm z-20 hidden">
        <div class="flex items-center gap-4">
            <button id="exit-btn" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-100 text-slate-400 hover:text-rose-600 transition-colors" title="End Game">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                <div class="bg-rose-500 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-clone text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-none">Set Match</h1>
                    <p id="mode-label" class="text-xs text-slate-500 font-semibold uppercase">Timed Mode</p>
                </div>
            </div>
        </div>

        <div class="flex gap-8 text-sm md:text-base">
            <div class="text-center">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Sets</p>
                <p id="score-display" class="font-bold text-xl tabular-nums leading-none">0</p>
            </div>
            <div class="text-center">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Time</p>
                <p id="time-display" class="font-bold text-xl tabular-nums leading-none">60s</p>
            </div>
        </div>
    </header>

    <!-- Submenu (Mode Selection) -->
    <div id="submenu" class="absolute inset-0 z-30 flex flex-col items-center justify-center p-4 bg-slate-50">
        <div class="max-w-2xl w-full text-center space-y-8">
            <div class="space-y-2">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-rose-500 text-white mb-4 shadow-lg shadow-rose-200">
                    <i class="fa-solid fa-layer-group text-4xl"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tight">Set Match</h1>
                <p class="text-slate-500 text-lg">Select your challenge mode</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <!-- Timed Mode -->
                <button onclick="startGame('timed')" class="mode-card bg-white p-8 rounded-2xl shadow-xl border-2 border-transparent hover:border-rose-500 text-left group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-rose-100 text-rose-600 p-3 rounded-xl">
                            <i class="fa-solid fa-stopwatch text-2xl"></i>
                        </div>
                        <span class="text-rose-500 font-bold opacity-0 group-hover:opacity-100 transition-opacity">Go <i class="fa-solid fa-arrow-right ml-1"></i></span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">Timed Mode</h3>
                    <p class="text-slate-500 text-sm">Find as many sets as possible in 60 seconds. Fast thinking required!</p>
                </button>

                <!-- Zen Mode -->
                <button onclick="startGame('zen')" class="mode-card bg-white p-8 rounded-2xl shadow-xl border-2 border-transparent hover:border-emerald-500 text-left group">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-emerald-100 text-emerald-600 p-3 rounded-xl">
                            <i class="fa-solid fa-infinity text-2xl"></i>
                        </div>
                        <span class="text-emerald-500 font-bold opacity-0 group-hover:opacity-100 transition-opacity">Go <i class="fa-solid fa-arrow-right ml-1"></i></span>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">Zen Mode</h3>
                    <p class="text-slate-500 text-sm">Play at your own pace with no time limit. Relax and find patterns.</p>
                </button>
            </div>

            <a href="index.html" class="inline-block text-slate-400 hover:text-slate-600 font-semibold text-sm mt-8">
                <i class="fa-solid fa-house mr-1"></i> Back to Platform
            </a>
        </div>
    </div>

    <!-- Main Game Area -->
    <main class="flex-grow flex flex-col items-center justify-center relative p-4 overflow-y-auto" id="game-main" style="display: none;">
        <div id="game-board">
            <!-- Cards injected by JS -->
        </div>
    </main>

    <!-- Score Overlay -->
    <div id="overlay" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/40 backdrop-blur-sm p-8 transition-all duration-500">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4">
            <h2 id="overlay-title" class="text-3xl font-black mb-6 text-slate-800">Time's Up!</h2>

            <div id="overlay-content" class="mb-8">
                <div class="flex flex-col items-center">
                    <p class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">Sets Found</p>
                    <p id="final-score" class="text-6xl font-black text-rose-500 mb-2">0</p>
                </div>
            </div>

            <div class="space-y-3">
                <button id="action-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-6 rounded-xl transition-transform hover:-translate-y-1 active:translate-y-0 shadow-lg">
                    Play Again
                </button>
                <button id="menu-btn" class="w-full bg-white border-2 border-slate-200 hover:border-slate-300 text-slate-600 font-bold py-4 px-6 rounded-xl transition-colors">
                    Main Menu
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Toast -->
    <div id="feedback" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-40 opacity-0 transition-all duration-300 font-black text-6xl drop-shadow-2xl scale-50 whitespace-nowrap text-white text-center">
        <!-- Text injected by JS -->
    </div>

    <!-- Invisible SVG Defs for Patterns -->
    <svg width="0" height="0" class="absolute pointer-events-none" style="z-index: -1;">
        <defs>
            <pattern id="striped-red" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="4" stroke="#ef4444" stroke-width="2" /></pattern>
            <pattern id="striped-green" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="4" stroke="#22c55e" stroke-width="2" /></pattern>
            <pattern id="striped-purple" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="4" stroke="#a855f7" stroke-width="2" /></pattern>
        </defs>
    </svg>

    <script>
        // --- Constants & Enums ---
        const COLORS = ['#ef4444', '#22c55e', '#a855f7']; // Red, Green, Purple
        const SHAPES = ['diamond', 'oval', 'squiggle'];
        const NUMBERS = [1, 2, 3];
        const SHADINGS = ['solid', 'striped', 'open'];
        const STRIPE_IDS = ['striped-red', 'striped-green', 'striped-purple'];

        // --- Game State ---
        let deck = [];
        let board = [];
        let selectedIndices = [];
        let score = 0;
        let timer = 0; // Represents timeLeft (Timed) or timeElapsed (Zen)
        let timerInterval = null;
        let isGameActive = false;
        let lastSetTime = 0;
        let currentMode = 'timed'; // 'timed' or 'zen'

        // --- DOM Elements ---
        const mainBody = document.getElementById('main-body');
        const boardEl = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score-display');
        const timeDisplay = document.getElementById('time-display');
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const finalScoreEl = document.getElementById('final-score');
        const actionBtn = document.getElementById('action-btn');
        const menuBtn = document.getElementById('menu-btn');
        const exitBtn = document.getElementById('exit-btn');
        const feedbackEl = document.getElementById('feedback');
        const effectsLayer = document.getElementById('effects-layer');
        const submenu = document.getElementById('submenu');
        const gameHeader = document.getElementById('game-header');
        const gameMain = document.getElementById('game-main');
        const modeLabel = document.getElementById('mode-label');

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            if (type === 'select') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'match') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'error') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'firework') {
                const bufferSize = audioCtx.sampleRate * 0.5;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseFilter = audioCtx.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.value = 1000;
                const noiseEnvelope = audioCtx.createGain();
                noiseEnvelope.gain.setValueAtTime(0.5, now);
                noiseEnvelope.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseEnvelope);
                noiseEnvelope.connect(audioCtx.destination);
                noise.start(now);
            } else if (type === 'confetti') {
                [0, 0.1, 0.2].forEach((offset, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    const freqs = [523.25, 659.25, 783.99];
                    osc.frequency.setValueAtTime(freqs[i], now + offset);
                    gain.gain.setValueAtTime(0.1, now + offset);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + offset + 0.3);
                    osc.start(now + offset);
                    osc.stop(now + offset + 0.3);
                });
            } else if (type === 'end') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.5);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        // --- Visual Effects ---

        function triggerFireworks() {
            const rect = effectsLayer.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7'];

            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.className = 'absolute w-3 h-3 rounded-full';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';
                effectsLayer.appendChild(el);

                const angle = Math.random() * Math.PI * 2;
                const velocity = 150 + Math.random() * 200;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                el.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 2000 + Math.random() * 400,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                }).onfinish = () => el.remove();
            }
        }

        function triggerConfetti() {
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#a855f7'];

            for (let i = 0; i < 50; i++) {
                const el = document.createElement('div');
                el.className = 'absolute w-3 h-3';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.left = Math.random() * 100 + '%';
                el.style.top = '-20px';
                effectsLayer.appendChild(el);

                const rotation = Math.random() * 360;

                el.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) rotate(${rotation + 720}deg)`, opacity: 0 }
                ], {
                    duration: 1500 + Math.random() * 1000,
                    easing: 'linear'
                }).onfinish = () => el.remove();
            }
        }

        // --- Game Logic ---

        class Card {
            constructor(color, shape, number, shading) {
                this.color = color;
                this.shape = shape;
                this.number = number;
                this.shading = shading;
                this.id = Math.random().toString(36);
            }
        }

        function generateDeck() {
            const newDeck = [];
            for (let c = 0; c < 3; c++) {
                for (let s = 0; s < 3; s++) {
                    for (let n = 0; n < 3; n++) {
                        for (let h = 0; h < 3; h++) {
                            newDeck.push(new Card(c, s, n, h));
                        }
                    }
                }
            }
            for (let i = newDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
            }
            return newDeck;
        }

        function startGame(mode) {
            currentMode = mode;

            // UI Transition
            submenu.classList.add('hidden');
            gameHeader.classList.remove('hidden');
            gameMain.style.display = 'flex';
            overlay.classList.add('hidden');

            modeLabel.innerText = mode === 'timed' ? 'Timed Mode' : 'Zen Mode';
            exitBtn.title = mode === 'timed' ? "End Game" : "Main Menu";

            deck = generateDeck();
            board = [];
            score = 0;
            selectedIndices = [];
            lastSetTime = Date.now();

            // Set Timer Init
            if (currentMode === 'timed') {
                timer = 60;
                timeDisplay.classList.remove('text-emerald-600');
            } else {
                timer = 0;
                timeDisplay.classList.add('text-emerald-600');
                timeDisplay.classList.remove('text-rose-500');
            }

            for (let i = 0; i < 12; i++) {
                if (deck.length > 0) board.push(deck.pop());
            }

            ensureSetExists();
            renderBoard();
            updateHUD();
            startTimer();
            isGameActive = true;
        }

        function showMainMenu() {
            clearInterval(timerInterval);
            isGameActive = false;
            gameHeader.classList.add('hidden');
            gameMain.style.display = 'none';
            overlay.classList.add('hidden');
            submenu.classList.remove('hidden');
        }

        function ensureSetExists() {
            while (!findSetIndices(board) && deck.length > 0) {
                for (let i = 0; i < 3; i++) {
                    if (deck.length > 0) board.push(deck.pop());
                }
            }
        }

        function isSet(c1, c2, c3) {
            if (!c1 || !c2 || !c3) return false;
            const features = ['color', 'shape', 'number', 'shading'];
            for (let f of features) {
                const v1 = c1[f];
                const v2 = c2[f];
                const v3 = c3[f];
                const allSame = (v1 === v2 && v2 === v3);
                const allDiff = (v1 !== v2 && v1 !== v3 && v2 !== v3);
                if (!allSame && !allDiff) return false;
            }
            return true;
        }

        function findSetIndices(currentBoard) {
            for (let i = 0; i < currentBoard.length; i++) {
                for (let j = i + 1; j < currentBoard.length; j++) {
                    for (let k = j + 1; k < currentBoard.length; k++) {
                        if (isSet(currentBoard[i], currentBoard[j], currentBoard[k])) {
                            return [i, j, k];
                        }
                    }
                }
            }
            return null;
        }

        function handleCardClick(index) {
            if (!isGameActive) return;
            const idxInSelection = selectedIndices.indexOf(index);
            if (idxInSelection > -1) {
                selectedIndices.splice(idxInSelection, 1);
                renderSelection();
                playSound('select');
            } else {
                if (selectedIndices.length < 3) {
                    selectedIndices.push(index);
                    renderSelection();
                    playSound('select');
                    if (selectedIndices.length === 3) setTimeout(checkSelection, 100);
                }
            }
        }

        function checkSelection() {
            const [i1, i2, i3] = selectedIndices;
            const c1 = board[i1];
            const c2 = board[i2];
            const c3 = board[i3];

            if (isSet(c1, c2, c3)) {
                score++;

                const now = Date.now();
                const diff = (now - lastSetTime) / 1000;
                lastSetTime = now;

                let cardAnimClass = "matched-basic";
                let sound = 'match';

                if (diff < 5) {
                    cardAnimClass = "matched-high-tier";
                    triggerFireworks();
                    playSound('firework');
                } else if (diff < 10) {
                    cardAnimClass = "matched-high-tier";
                    triggerConfetti();
                    playSound('confetti');
                } else {
                    playSound('match');
                }

                // Remove cards from board
                const indicesToRemove = [i1, i2, i3].sort((a, b) => b - a);

                // Apply Animation
                indicesToRemove.forEach(idx => {
                    const el = document.getElementById(`card-${idx}`);
                    if (el) {
                        el.classList.add(cardAnimClass);
                        el.style.zIndex = "50";
                    }
                });

                setTimeout(() => {
                    if (board.length > 12 || deck.length === 0) {
                         indicesToRemove.forEach(idx => board.splice(idx, 1));
                    } else {
                        indicesToRemove.forEach(idx => {
                            if (deck.length > 0) board[idx] = deck.pop();
                            else board.splice(idx, 1);
                        });
                    }
                    ensureSetExists();
                    selectedIndices = [];
                    renderBoard();
                    updateHUD();
                }, 400);

            } else {
                playSound('error');
                selectedIndices.forEach(idx => {
                    const el = document.getElementById(`card-${idx}`);
                    if (el) el.classList.add('shake-anim');
                });
                setTimeout(() => {
                    selectedIndices = [];
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(c => c.classList.remove('shake-anim'));
                    renderSelection();
                }, 400);
            }
        }

        function renderBoard() {
            boardEl.innerHTML = '';
            board.forEach((card, index) => {
                const el = document.createElement('div');
                el.id = `card-${index}`;
                el.className = 'card';
                el.addEventListener('click', () => handleCardClick(index));

                const shapeContent = renderShape(card);
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'flex flex-col gap-1 md:gap-2 items-center justify-center w-full h-full pointer-events-none';

                for (let i = 0; i < NUMBERS[card.number]; i++) {
                    const shapeWrapper = document.createElement('div');
                    shapeWrapper.style.width = '100%';
                    shapeWrapper.style.height = '30%';
                    shapeWrapper.style.maxHeight = '40px';
                    shapeWrapper.innerHTML = shapeContent;
                    contentWrapper.appendChild(shapeWrapper);
                }
                el.appendChild(contentWrapper);
                boardEl.appendChild(el);
            });
            renderSelection();
        }

        function renderSelection() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('selected'));
            selectedIndices.forEach(idx => {
                const el = document.getElementById(`card-${idx}`);
                if (el) el.classList.add('selected');
            });
        }

        function renderShape(card) {
            const color = COLORS[card.color];
            const shape = SHAPES[card.shape];
            const shading = SHADINGS[card.shading];
            let fill = 'transparent';
            let stroke = color;

            if (shading === 'solid') fill = color;
            else if (shading === 'striped') fill = `url(#${STRIPE_IDS[card.color]})`;

            if (shape === 'oval') {
                return `<svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
                    <rect x="5" y="5" width="90" height="40" rx="20" ry="20" fill="${fill}" stroke="${stroke}" stroke-width="4" />
                </svg>`;
            } else if (shape === 'diamond') {
                return `<svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
                    <polygon points="5,25 50,5 95,25 50,45" fill="${fill}" stroke="${stroke}" stroke-width="4" stroke-linejoin="round"/>
                </svg>`;
            } else if (shape === 'squiggle') {
                return `<svg viewBox="0 0 100 50" preserveAspectRatio="xMidYMid meet">
                    <path d="M10,15 Q30,0 50,15 T90,15 Q98,25 90,35 Q70,50 50,35 T10,35 Q2,25 10,15 Z" fill="${fill}" stroke="${stroke}" stroke-width="4" stroke-linejoin="round"/>
                </svg>`;
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            updateHUD();
            timerInterval = setInterval(() => {
                if (!isGameActive) return;

                if (currentMode === 'timed') {
                    timer--;
                    if (timer <= 0) endGame();
                } else {
                    timer++;
                }
                updateHUD();
            }, 1000);
        }

        function endGame() {
            clearInterval(timerInterval);
            isGameActive = false;

            if (currentMode === 'timed') {
                // Highlight last set if exists for timed mode
                const validSetIndices = findSetIndices(board);
                if (validSetIndices) {
                    playSound('reveal');
                    validSetIndices.forEach(idx => {
                        const el = document.getElementById(`card-${idx}`);
                        if (el) el.classList.add('missed-set-highlight');
                    });
                    setTimeout(showScoreModal, 2500);
                } else {
                    showScoreModal();
                }
            } else {
                showScoreModal(); // Instant for Zen manual quit
            }
        }

        function showScoreModal() {
            playSound('end');
            const title = currentMode === 'timed' ? "Time's Up!" : "Zen Complete";
            overlayTitle.innerText = title;
            finalScoreEl.innerText = score;

            overlay.classList.remove('hidden');
        }

        function updateHUD() {
            scoreDisplay.innerText = score;

            if (currentMode === 'timed') {
                timeDisplay.innerText = `${timer}s`;
                if (timer <= 10) timeDisplay.classList.add('text-rose-500');
                else timeDisplay.classList.remove('text-rose-500');
            } else {
                // Format time as M:SS for Zen
                const m = Math.floor(timer / 60);
                const s = timer % 60;
                timeDisplay.innerText = `${m}:${s.toString().padStart(2, '0')}`;
            }
        }

        // Action Buttons
        actionBtn.addEventListener('click', () => {
            startGame(currentMode); // Restart same mode
        });

        menuBtn.addEventListener('click', showMainMenu);

        exitBtn.addEventListener('click', endGame);

    </script>
</body>
</html>
